#! /bin/bash -e

# This script is here for compatibility & may be removed in the future.

TYPE="b"
STATIC=0

function usage {
    echo -e "\n    USAGE: ./configure [--help] [--type=TYPE] [--static]"
	echo -e "\n    Options:"
	echo -e "\t--help\t\tShow this help text"
    echo -e "\n\t--type=TYPE\tSet to \"b\" (default) for binary executable"
    echo -e "\t\t\t\"s\" for Python script"
    echo -e "\n\t--static\tCreate statically linked executable (binary"
	echo -e "\t\t\tonly)\n\n"
}

MAX_ARGS=2

if [ "${#}" -gt "${MAX_ARGS}" ]
then
    usage
    exit 1
fi

for A in $@; do
	if [[ "${A}" == *"="* ]]; then
		K=($(echo ${A} | tr  "=" " "))
		if [ "${K[0]}" != "--type" ]; then
			echo -e "\nERROR: Unknown argument: \"${K[0]}\""
			exit 1
		else
			if [[ "${K[1]}" == "b" || "${K[1]}" == "s" ]]; then
				TYPE="${K[1]}"
			else
				echo -e "\nERROR: Bad argument for option \"${K[0]}\"\n"
				exit 1
			fi
		fi
	else
		if [ "${A}" == "--help" ]; then
			usage
			exit 0
		elif [ "${A}" == "--type" ]; then
			echo -e "\nERROR: Argument ${A} requires a value: ${A}=TYPE"
			exit 1
		elif [ "${A}" == "--static" ]; then
			STATIC=1
		else
			echo -e "\nERROR: Unknown argument \"${A}\""
			exit 1
		fi
	fi
done

if [[ "${TYPE}" == "s" && "${STATIC}" -ne "0" ]]; then
	echo -e "\nERROR: --static can only be specified with type \"b\""
	exit 1
fi


# create Makefile
if [ "${TYPE}" == "b" ]
then
	if [ "${STATIC}" -gt "0" ]
	then
		MAKE="bin2header: man src/bin2header.cpp\n\tg++ -static -O2 -s src/bin2header.cpp -o bin2header"
	else
		MAKE="bin2header: man src/bin2header.cpp\n\tg++ -O2 -s src/bin2header.cpp -o bin2header"
	fi
elif [ "${TYPE}" == "s" ]
then
	MAKE="bin2header: man src/bin2header.py\n\t@cp -v src/bin2header.py bin2header"
fi

# Install file
#INSTALL="#! /bin/bash\n\ncp bin2header /usr/local/bin\ncp man/bin2header.1.gz /usr/#share/man/man1"
#echo -e "${INSTALL}" > "install"
#chmod +x "install"

#MAKEINSTALL="install:\n\t./install"
MAKEMAN=".PHONY: man\nman: man/bin2header.1\n\tgzip -fk9 man/bin2header.1"
MAKEINSTALL="install:\n\t@mkdir -vp \$(DESTDIR)/usr/local/bin \$(DESTDIR)/usr/share/man/man1\n\t@cp -v bin2header \$(DESTDIR)/usr/local/bin && cp -v man/bin2header.1.gz \$(DESTDIR)/usr/share/man/man1"
MAKEUNINSTALL="uninstall:\n\t@rm -vf \$(DESTDIR)/usr/local/bin/bin2header \$(DESTDIR)/usr/share/man/man1/bin2header.1.gz"
MAKECLEAN="clean:\n\t@rm -vf man/bin2header.1.gz bin2header"
MAKEDISTCLEAN="distclean: clean"
MAKEFILE="${MAKE}\n${MAKEMAN}\n${MAKEINSTALL}\n${MAKEUNINSTALL}\n${MAKECLEAN}\n${MAKEDISTCLEAN}"
echo -e "${MAKEFILE}" > Makefile
echo -e "\nDone!"
echo -e "\nNow run \"make\" and \"make install\"\n"

exit 0
